{% extends "base.html" %}
{% block title %}Min Profil{% endblock %}
{% block content %}
<div class="profile-card {{ user.template }}"
     style="font-family: {{ user.font_family }}; color: {{ user.theme_color }};">

  {# —— Profilbild —— #}
  {% if user.profile_image %}
    {% if config['UPLOAD_FOLDER'].startswith('/user/data') %}
      {# På Render: hämta från /uploads/filnamn #}
      <img src="{{ url_for('uploaded_file', filename=user.profile_image) }}" class="profile-img">
    {% else %}
      {# Lokalt: hämta från /static/uploads/filnamn #}
      <img src="{{ url_for('static', filename='uploads/' ~ user.profile_image) }}" class="profile-img">
    {% endif %}
  {% else %}
    {# Ingen profilbild: visa default‐bild #}
    <img src="{{ url_for('static', filename='uploads/default-profile.png') }}" class="profile-img">
  {% endif %}

  <h2>@{{ user.display_name or user.username }}</h2>
  <p>{{ user.bio or "Ingen beskrivning ännu." }}</p>

  <div class="links">
    {% for link in sorted_links %}
      {% set icon = "" %}
      {% if "instagram" in link.url %}   {% set icon = "fab fa-instagram" %}
      {% elif "facebook"  in link.url %}  {% set icon = "fab fa-facebook" %}
      {% elif "linkedin"  in link.url %}  {% set icon = "fab fa-linkedin" %}
      {% elif "youtube"   in link.url %}  {% set icon = "fab fa-youtube" %}
      {% elif "twitter"   in link.url %}  {% set icon = "fab fa-twitter" %}
      {% elif "snapchat"  in link.url %}  {% set icon = "fab fa-snapchat" %}
      {% elif "github"    in link.url %}  {% set icon = "fab fa-github" %}
      {% elif "tiktok"    in link.url %}  {% set icon = "fab fa-tiktok" %}
      {% elif "spotify.com"    in link.url %}{% set icon = "fab fa-spotify"    %}
      {% elif "soundcloud.com" in link.url %}{% set icon = "fab fa-soundcloud" %}
      {% elif "vimeo.com"      in link.url %}{% set icon = "fab fa-vimeo-v"    %}
      {% elif "twitch.tv"      in link.url %}{% set icon = "fab fa-twitch"     %}
      {% elif "dribbble.com"   in link.url %}{% set icon = "fab fa-dribbble"   %}
      {% elif "behance.net"    in link.url %}{% set icon = "fab fa-behance"    %}
      {% elif "medium.com"     in link.url %}{% set icon = "fab fa-medium"     %}
      {% elif "pinterest.com"  in link.url %}{% set icon = "fab fa-pinterest"  %}
      {% elif "reddit.com"     in link.url %}{% set icon = "fab fa-reddit"     %}
      {% elif "tumblr.com"     in link.url %}{% set icon = "fab fa-tumblr"     %}
      {% elif "whatsapp.com"   in link.url %}{% set icon = "fab fa-whatsapp"   %}
      {% elif "telegram.me"    in link.url %}{% set icon = "fab fa-telegram"   %}
      {% elif "slack.com"      in link.url %}{% set icon = "fab fa-slack"      %}
      {% elif "discord.com"    in link.url %}{% set icon = "fab fa-discord"    %}
      {% elif "skype.com"      in link.url %}{% set icon = "fab fa-skype"      %}
      {% elif "vsco"           in link.url %}{% set icon = "fas fa-camera-retro" %}
      {% elif "mastodon"       in link.url %}{% set icon = "fab fa-mastodon"    %}
      {% endif %}
      <a class="link-button {{ user.template }}" href="{{ link.url }}" target="_blank">
        {% if icon %}<i class="{{ icon }}"></i>{% endif %}
        {{ link.label }}
      </a>
    {% endfor %}
  </div>

{% if not current_user.is_premium %}
  <button id="checkout-button" class="btn-stripe-premium">
    Skaffa Premium
  </button>
{% endif %}

<div id="premium-popup" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:2em; border-radius:12px; box-shadow:0 3px 18px rgba(0,0,0,0.11); max-width:360px; margin:auto; text-align:center;">
    <h3>Bli premium!</h3>
    <p>Att välja offentlig redirect är en premiumfunktion.<br>Uppgradera för att låsa upp!</p>
    <button id="checkout-button-popup" class="btn-stripe-premium" style="margin: 1em 0; display:inline-block;">
      Skaffa Premium
    </button><br>
    <button onclick="hidePremiumPopup()" style="margin-top:0.7em; background:#f3f3f3; border:none; padding:0.5em 1.5em; border-radius:6px;">
      Stäng
    </button>
  </div>
</div>

<script>
  function showPremiumPopup() {
    document.getElementById('premium-popup').style.display = 'flex';
  }
  function hidePremiumPopup() {
    document.getElementById('premium-popup').style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('checkout-button');
    const btnPopup = document.getElementById('checkout-button-popup');

    async function createCheckout() {
      // Ajax‐kall till backend som skapar en Stripe Checkout Session
      const res = await fetch("{{ url_for('billing.create_checkout_session') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: "{{ current_user.id }}" })
      });
      if (!res.ok) {
        // Om det blir fel (t.ex. 403) – visa en beskrivning eller popup
        alert("Något gick fel när vi skapade betalningssessionen. Försök igen.");
        return;
      }
      const data = await res.json();      // { sessionId: "…" }
      const stripe = Stripe("{{ stripe_public_key }}"); // genereras i billing.py via render_template
      await stripe.redirectToCheckout({ sessionId: data.sessionId });
    }

    if (btn)     btn.addEventListener("click", createCheckout);
    if (btnPopup) btnPopup.addEventListener("click", createCheckout);
  });
</script>



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      async function updateField(field) {
        const current = "{{ getattr(current_user, field) or '' }}";
        const newVal = prompt("Ange ny " + field.replace('_',' ') + ":", current);
        if (newVal === null) return;
        const payload = { [field]: newVal, ["show_" + field]: true };
        const res = await fetch("{{ url_for('dashboard.update_contact') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          window.location.reload();
        } else {
          alert("Något gick fel.");
        }
      }

      document.getElementById('edit-email').onclick = e => {
        e.preventDefault();
        updateField('email');
      };
      document.getElementById('edit-phone').onclick = e => {
        e.preventDefault();
        updateField('phone_number');
      };
    });
  </script>
</div>
{% endblock %}
