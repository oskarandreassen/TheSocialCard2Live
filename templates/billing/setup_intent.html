{% extends "base.html" %}

{% block title %}Uppgradera till Premium{% endblock %}

{% block content %}
<div class="checkout-summary">
  <h2>Du får:</h2>
  <ul>
    <li><strong>✔️ SocialCard NFC-kort (värde 249 kr) – GRATIS!</strong></li>
    <li><strong>✔️ Premium-medlemskap</strong> för <strong>19 kr/mån</strong></li>
    <li><strong>✔️ Omedelbar tillgång till premiumfunktioner</strong></li>
  </ul>
  <div class="price-info">
    <b>Att betala nu:</b> 19 kr/mån (ingen startavgift)
  </div>
</div>

<div class="center">
    <h2>Uppgradera till Premium</h2>
    <div class="checkout-price-summary">
        <p><b>Du betalar:</b> 19 kr/månad</p>
        <p><i>Kortet (värde 249 kr) ingår gratis vid tecknande av medlemskap!</i></p>
    </div>
    <form id="payment-form">
        <div id="payment-element"></div>
        <button id="submit">Betala och påbörja prenumeration</button>
    </form>
    <div id="error-message"></div>
</div>

console.log("Skickar payment_method_id:", setupIntent.payment_method);

<!-- Viktigt: Ladda Stripe.js innan ditt eget script -->
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
const clientSecret = "{{ client_secret }}";

const elements = stripe.elements({ clientSecret });
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');

const form = document.getElementById('payment-form');
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1. Bekräfta kortet/betalmetoden (detta triggar 3DS/Apple Pay mm)
    const { setupIntent, error } = await stripe.confirmSetup({
        elements,
        confirmParams: {
            // Du kan byta till /billing/success eller bara använda window.location om du vill.
            return_url: window.location.origin + "/billing/success"
        },
        redirect: "if_required" // Så vi får svar direkt i JS om ingen redirect behövs
    });

    if (error) {
        document.getElementById('error-message').textContent = error.message;
        return;
    }

    // 2. Skicka payment_method_id till din backend för att skapa subscription
    fetch('/billing/create-subscription', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            payment_method_id: setupIntent.payment_method
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.error) {
            document.getElementById('error-message').textContent = res.error;
        } else {
            // Allt gick bra! Skicka användaren vidare eller visa bekräftelse
            window.location.href = "/billing/success";
        }
    });
});
</script>

{% endblock %}
