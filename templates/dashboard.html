{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="dashboard-layout">

  <!-- 🎛️ DASHBOARD PANEL I MITTEN -->
  <div class="dashboard-panel">
    <h2>Välkommen, {{ user.username }}!</h2>

    {# ——— Mobil‐förhandsvisning inbäddad direkt under rubriken ——— #}
    <div class="mobile-only">
      <div class="mobile-preview {{ user.template }}"
           style="font-family: {{ user.font_family | default('Inter, sans-serif') }};
                  color: {{ user.theme_color or '#fff' }}; margin-bottom:1rem;">
        <div class="profile-card {{ user.template }}"
             style="font-family: inherit; color: inherit;">
          <img src="{{ url_for('static', filename=user.profile_image or 'default-profile.png') }}"
               class="profile-img">
          <h3>@{{ user.username }}</h3>
          <p>{{ user.bio or "Ingen beskrivning ännu." }}</p>
          <div class="links" id="preview-links">
            {% for link in sorted_links if link.is_visible %}
              {% set icon = "" %}
              {% if "instagram" in link.url %}{% set icon = "fab fa-instagram" %}
              {% elif "facebook" in link.url %}{% set icon = "fab fa-facebook" %}
              {% elif "linkedin" in link.url %}{% set icon = "fab fa-linkedin" %}
              {% elif "youtube" in link.url %}{% set icon = "fab fa-youtube" %}
              {% elif "twitter" in link.url %}{% set icon = "fab fa-twitter" %}{% endif %}
              <a class="link-button {{ user.template }}"
                 href="#"
                 onclick="return false;">
                {% if icon %}<i class="{{ icon }}"></i>{% endif %} {{ link.label }}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    {# ——— Desktop‐profilkort ——— #}
    <div class="profile-card desktop-only">
      <img src="{{ url_for('static', filename=user.profile_image or 'default-profile.png') }}"
           class="profile-img">
      <h3>@{{ user.username }}</h3>
      <p>{{ user.bio or "Ingen beskrivning ännu." }}</p>
    </div>

    <button id="openModal" class="btn action-btn">➕ Lägg till</button>

    <div id="addModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h3>Lägg till länk</h3>
        <form method="POST">
          <input name="label" placeholder="Titel (t.ex. LinkedIn)" required>
          <input name="url" placeholder="https://dinsida.com" required>
          <button type="submit">Spara</button>
        </form>
      </div>
    </div>

    <div id="link-list" class="links">
      {% for link in sorted_links %}
        {% set icon = "" %}
        {% if "instagram" in link.url %}{% set icon = "fab fa-instagram" %}
        {% elif "facebook" in link.url %}{% set icon = "fab fa-facebook" %}
        {% elif "linkedin" in link.url %}{% set icon = "fab fa-linkedin" %}
        {% elif "youtube" in link.url %}{% set icon = "fab fa-youtube" %}
        {% elif "twitter" in link.url %}{% set icon = "fab fa-twitter" %}{% endif %}

        <div class="link-card"
             data-id="{{ link.id }}"
             data-label="{{ link.label }}"
             data-url="{{ link.url }}"
             data-icon="{{ icon }}"
             data-visible="{{ link.is_visible }}">
          <form class="edit-link-form" style="display: none;">
            <input type="text" name="label" value="{{ link.label }}" required>
            <input type="url" name="url" value="{{ link.url }}" required>
            <button type="submit">📂</button>
          </form>

          <div class="link-main">
            <div class="link-info">
              {% if icon %}<i class="{{ icon }}"></i>{% endif %}
              <span class="link-label">{{ link.label }}</span>
            </div>
            <div class="link-actions">
              <form method="POST"
                    action="{{ url_for('dashboard.toggle_link_visibility', link_id=link.id) }}">
                <button type="submit" class="link-btn" title="Visa/dölj länk">
                  {% if link.is_visible %}👁️{% else %}❌{% endif %}
                </button>
              </form>
              <a href="#" class="link-btn edit-btn" title="Redigera">✏️</a>
              <a href="{{ url_for('dashboard.delete_link', link_id=link.id) }}"
                 class="link-btn" title="Radera">🗑️</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- 📱 FÖRHANDSVISNING TILL HÖGER – visas ENBART på desktop -->
  <div class="preview-panel desktop-only">
    <div class="mobile-preview {{ user.template }}"
         style="font-family: {{ user.font_family | default('Inter, sans-serif') }};
                color: {{ user.theme_color or '#fff' }};">
      <div class="profile-card {{ user.template }}"
           style="font-family: inherit; color: inherit;">
        <img src="{{ url_for('static', filename=user.profile_image or 'default-profile.png') }}"
             class="profile-img">
        <h3>@{{ user.username }}</h3>
        <p>{{ user.bio or "Ingen beskrivning ännu." }}</p>
        <div class="links" id="preview-links">
          {% for link in sorted_links if link.is_visible %}
            {% set icon = "" %}
            {% if "instagram" in link.url %}{% set icon = "fab fa-instagram" %}
            {% elif "facebook" in link.url %}{% set icon = "fab fa-facebook" %}
            {% elif "linkedin" in link.url %}{% set icon = "fab fa-linkedin" %}
            {% elif "youtube" in link.url %}{% set icon = "fab fa-youtube" %}
            {% elif "twitter" in link.url %}{% set icon = "fab fa-twitter" %}{% endif %}
            <a class="link-button {{ user.template }}"
               href="#"
               onclick="return false;">
              {% if icon %}<i class="{{ icon }}"></i>{% endif %} {{ link.label }}
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ——— Mobile (≤600px): göm desktop‐kortet och preview-panelen längst till höger ——— */
  @media (max-width: 600px) {
    .desktop-only  { display: none !important; }
    .mobile-only   { display: block !important; }
    .preview-panel { display: none !important; }

    /* << VÅR NYA CENTRERINGSREGEL >> */
    .mobile-only {
      display: flex !important;
      justify-content: center;
    }
  }
  /* ——— Desktop (≥601px): göm det inbäddade mobilen, visa allt annat ——— */
  @media (min-width: 601px) {
    .mobile-only   { display: none !important; }
    .desktop-only  { display: block !important; }
    .preview-panel { display: block !important; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  // Sortable + redigering + modal-skript oförändrat...
  const el = document.getElementById('link-list');
  const previewLinks = document.getElementById('preview-links');
  new Sortable(el, {
    animation: 150,
    onEnd() {
      const order = [...el.children].map(r => r.dataset.id);
      fetch('/update_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order })
      }).then(() => {
        previewLinks.innerHTML = '';
        [...el.children].filter(r => r.dataset.visible==='True')
          .forEach(r => {
            const a = document.createElement('a');
            a.className = `link-button {{ user.template }}`;
            a.href = "#"; a.onclick = ()=>false;
            a.innerHTML = r.dataset.icon
              ? `<i class="${r.dataset.icon}"></i> ${r.dataset.label}`
              : r.dataset.label;
            previewLinks.appendChild(a);
          });
      });
    }
  });

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      const card = btn.closest('.link-card');
      card.querySelector('.edit-link-form').style.display = 'flex';
      card.querySelector('.link-main').style.display = 'none';
    });
  });
  document.querySelectorAll('.edit-link-form').forEach(form => {
    form.addEventListener('submit', e => {
      e.preventDefault();
      const card = form.closest('.link-card');
      const id = card.dataset.id;
      fetch(`/edit_link_inline/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          label: form.label.value, url: form.url.value
        })
      }).then(() => location.reload());
    });
  });

  const modal = document.getElementById("addModal");
  document.getElementById("openModal").onclick = () => modal.style.display = "flex";
  document.getElementById("closeModal").onclick = () => modal.style.display = "none";
  window.onclick = e => { if (e.target==modal) modal.style.display="none"; };
</script>
{% endblock %}
